{% from "webshop/templates/includes/macros.html" import user_review, ratings_summary %}

<div class=" ratings-reviews-section col-12 hide-top-border-lg mt-4">
		<!-- Title and Action -->
		<div class="w-100 d-flex">
			<div class="reviews-header col-6 text-purple" style="height:30px">
				{{ _("Customer Reviews") }}
			</div>

			<div class="write-a-review-btn col-6">
				<!-- Write a Review for legitimate users -->
				{% if frappe.session.user != "Guest" and user_is_customer %}
					<button class="btn btn-write-review border"
						data-web-item="{{ doc.name }}">
						{{ _("Write a Review") }}
					</button>
				{% endif %}
			</div>
		</div>

		<!-- Summary -->
		{{ ratings_summary(reviews, reviews_per_rating, average_rating, average_whole_rating,doc, for_summary=True, total_reviews=total_reviews) }}


	<!-- Reviews and Comments -->
	
</div>

<script>
	frappe.ready(() => {
    const $pageContent = $('.page_content');

    $pageContent.find('.btn-write-review').one('click', function (e) {
        const $btn = $(e.currentTarget);

        const d = new frappe.ui.Dialog({
            title: __("Write a Review"),
            fields: [
                { fieldname: "title", fieldtype: "Data", label: __("Headline"), reqd: 1 },
                { fieldname: "rating", fieldtype: "Rating", label: __("Overall Rating"), reqd: 1 },
                { fieldtype: "Section Break" },
                { fieldname: "comment", fieldtype: "Small Text", label: __("Your Review") }
            ],
            primary_action: function () {
                const data = d.get_values();
                frappe.call({
                    method: "webshop.webshop.doctype.item_review.item_review.add_item_review",
                    args: {
                        web_item: "{{ doc.name }}",
                        title: data.title,
                        rating: data.rating,
                        comment: data.comment
                    },
                    freeze: true,
                    freeze_message: __("Submitting Review ..."),
                    callback: function (r) {
                        if (!r.exc) {
                            frappe.msgprint({
                                message: __("Thank you for the review"),
                                title: __("Review Submitted"),
                                indicator: "green"
                            });
                            d.hide();
                            location.reload();
                        }
                    }
                });
            },
            primary_action_label: __("Submit")
        });
        d.show();
    });
});

</script>
